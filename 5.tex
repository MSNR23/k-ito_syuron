\chapter[3次元剛体2リンクによるパラメータに応じた投擲フォーム戦略の考察]{3次元剛体2リンクによるパラメータに応じた投擲フォーム戦略の考察}

\section{はじめに}
前章では2次元モデルでの投擲フォーム戦略の考察を行ったが、3次元に拡張することにより、より人間に近いモデルでの投擲フォーム戦略の考察が可能となると考えられる。そこで本章では、3次元モデルによる投擲物の重さに応じた投擲フォームの比較により、考察した投擲フォーム戦略について述べる。
\section{動力学モデル}
本章で用いた動力学モデルを\figref{5.1.eps}に示す。本章では、\figref{5.2.eps}で示す物理エンジンMuJoCoに標準搭載されているhumanoidモデル「Unitree G1」を改変し、人間の腕を肩関節3自由度と肘関節1自由度の計4自由度から構成される3次元剛体2リンクとしてモデル化した。なお、\figref{5.1.eps}において、肩関節から肘関節までを上腕リンク、肘関節から手先までを前腕リンクとし、手首や指の自由度は0とした。また、体幹リンクも自由度0とし、世界座標に固定した。
\fig{5.1.eps}{width=0.5\hsize}{3D rigid body 2 links}
\fig{5.2.eps}{width=0.5\hsize}{Unitree G1}
\section{シミュレータの作成}
3次元剛体2リンクを強化学習するためのQ学習シミュレータをpythonで実装した。運動方程式は、MuJoCoで内部的に解いた。runge-kutta法により数値積分し運動学を解くことで、3次元剛体2リンクの角度や角速度を計算する。
\section{可動範囲}
本章における可動範囲を\tabref{5.1}に示す。それぞれの可動範囲は、各自由度のそれぞれの静的な可動範囲に基づいて設定した。\figref{5.6.eps}が各自由度0 deg の際の各平面からの姿勢であり、MuJoCoにおける回転方向は右ねじの法則に基づいて定義されている。各軸の回転方向は次の通りである。

肩関節ピッチ軸周りの回転：肩関節の伸展方向が正、屈曲方向が負
肩関節ロール軸周りの回転：肩関節の内転方向が正、外転方向が負
肩関節ヨー軸周りの回転：肩関節の内旋方向が正、外旋方向が負
肘関節周りの回転：肩関節の伸展方向が正、屈曲方向が負

\fig{5.6.eps}{width=0.5\hsize}{Model viewed from each plane}

\begin{table}[tb]
  \tablabel{5.1}
  \begin{center}
    \caption{Range of motion: shoulder 3 degrees of freedom, elbow 1 degree of freedom}

    \begin{tabular}{c c c c}
      \hline
      Freedom & Unit & Min Range & Max Range \\
      \hline
      Shoulder pitch & deg & -135 & 45 \\
      Shoulder roll & deg & -135 & -35 \\
      Shoulder yaw & deg & -150 & 180 \\
      elbow pitch & deg & -20 & 90 \\
      \hline
    \end{tabular}
  \end{center}
\end{table}

\tabref{5.1}の可動範囲は各自由度ごとに見ると人間が可能な姿勢である。しかし人間の各関節は互いに干渉するため、組み合わせ次第では人間が不可能な姿勢となる。よって、肩関節ピッチ軸周り、ロール軸周り、ヨー軸周り、肘関節周りの順に、可動範囲を人間が可能な姿勢に収まるように設定した。\\
まず、肩関節ピッチ軸周りの可動範囲に基づいた肩関節ロール軸周りの可動範囲について確認したところ、全ての可動範囲で人間が可能な姿勢であったためそのまま可動範囲として採用した。次に肩関節ピッチ軸周りとロール軸周りに基づいた可動範囲について確認したところ、組み合わせ次第で人間が不可能な姿勢を取ることを確認した。そこで、スプライン補間を用いて肩関節ピッチ軸周りとロール軸周りの角度によって可動範囲が変動するように設定した。最後に肩関節に基づいた肘関節について確認したところ、全ての可動範囲で人間が可能な姿勢であったため、そのまま可動範囲として設定した。以上の設定により、全ての関節角度の組み合わせで人間が可能な姿勢を取ることができる。なお、計算精度上、数 deg 可動範囲外の角度を取ることがあるが、異常姿勢ではないため問題ないとした。

\section{強化学習の設定}
\subsection{状態}
状態変数は8つとし、肩関節ピッチ軸まわりの角度$\theta_{p}$、角速度$\dot{\theta}_{p}$,肩関節ロール軸まわりの角度$\theta_{r}$、角速度$\dot{\theta}_{r}$,肩関節ヨー軸まわりの角度$\theta_{y}$、角速度$\dot{\theta}_{y}$,肘関節の角度$\theta_{e}$、角速度$\dot{\theta}_{e}$とした。\\
各関節の角度については、5.4章の通りである。
また、各関節の角速度については、-10.0 m/s $\le$ $\dot{\theta}_{1}$ $\le$ 10.0 m/s、-10.0 m/s $\le$ $\dot{\theta}_{2}$ $\le$ 10.0 m/sとした。
分割数は各角度が5分割、各角速度が2分割であり、全ての状態を$5^{4}\times 2^{4}$=10000通りで表すことができる。
\subsection{行動}
行動は、全625通りに設定した。肩関節にかかるトルクを正2通り、0、負2通りの計5通り、同様に肘関節にかかるトルクも正2通り、0、負2通りの計5通りとした。
これにより、Qテーブルは10000$\times$625=6250000通りで表すことができる。
\subsection{報酬}
本章では、投擲物の飛距離を報酬とした。投擲物のモデル化は行っていないため、投射中の投擲物に生じる空気抵抗等は考慮しないものとする。\\
飛距離の計算にあたり、ピッチ、ロール、ヨーの3方向成分の手先速度をMuJoCoより取得し、それぞれ$v_{p}$、$v_{r}$、$v_{y}$とした。手先速度成分の合成は、

\begin{eqnarray}
  \equlabel{5.1}
  v_{syn} = \sqrt{v_{p}^{2} + v_{r}^{2} + v_{y}^{2}}
\end{eqnarray}

\begin{eqnarray}
  \equlabel{5.2}
  v_{pr} = \sqrt{v_{p}^{2} + v_{r}^{2}}
\end{eqnarray}

であり、\equref{5.1}、\equref{5.2}より投射角$\theta_{v}$は、

\begin{eqnarray}
  \equlabel{5.3}
  \theta_{v} = \arctan2(\frac{v_{y}}{v_{pr}})
\end{eqnarray}

各ステップ時のヨー軸成分の座標$h_{y}$を手先高さとする。しかし、この座標は肩関節を原点とした時の値であり、本来の手先高さは地面から肩関節までの高さを考慮する必要がある。よって、身長を$L$としたときの手先高さ$h$は、

\begin{eqnarray}
  \equlabel{5.4}
  h = 0.818L + h_{y}
\end{eqnarray}

リリース時の手先高さを考慮した投射時間$t$は、

\begin{eqnarray}
  \equlabel{5.5}
  t = \frac{v_{syn}\sin\theta_{v} + \sqrt{{v_{syn}}^2\sin^2\theta_{syn} + 2gh}}{g}
\end{eqnarray}


以上より、飛距離$D$は\equref{5.1}、\equref{5.3}、\equref{5.5}を用いて、

\begin{eqnarray}
  \equlabel{5.6}
  D = v_{syn} \cdot \cos\theta_{v} \cdot t
\end{eqnarray}

この報酬により、より直接的に遠投を行うための投擲フォームを導出することができる。また、2次元のときと同様に、罰則として累積消費エネルギーを採用し、\equref{5.11}で計算した。

\begin{eqnarray}
  \equlabel{5.7}
  CE_{p}&=&\int \tau_{p}(t)\cdot\dot{\theta}_{p} dt\\
        &\approx&|\tau_{p}(t)\cdot\dot{\theta}_{p}|\cdot\Delta t
\end{eqnarray}

\begin{eqnarray}
  \equlabel{5.8}
  CE_{r}&=&\int \tau_{r}(t)\cdot\dot{\theta}_{r} dt\\
        &\approx&|\tau_{r}(t)\cdot\dot{\theta}_{r}|\cdot\Delta t
\end{eqnarray}

\begin{eqnarray}
  \equlabel{5.9}
  CE_{y}&=&\int \tau_{y}(t)\cdot\dot{\theta}_{y} dt\\
        &\approx&|\tau_{y}(t)\cdot\dot{\theta}_{y}|\cdot\Delta t
\end{eqnarray}

$\tau_{p},\tau_{r},\tau_{y}$はそれぞれ肩関節ピッチ軸まわり、ロール軸まわり、ヨー軸まわりに与えるトルクである。また、$CE_{p},CE_{r},CE_{y}$はそれぞれ肩関節ピッチ軸まわり、ロール軸まわり、ヨー軸まわりの累積消費エネルギーであり、肩関節の累積消費エネルギーの合計は、

\begin{eqnarray}
  \equlabel{5.10}
  CE_{s} = CE_{p} + CE_{r} + CE_{y}
\end{eqnarray}

肘関節の累積消費エネルギーは、

\begin{eqnarray}
  \equlabel{5.11}
  CE_{e}&=&\int \tau_{e}(t)\cdot\dot{\theta}_{e} dt\\
        &\approx&|\tau_{e}(t)\cdot\dot{\theta}_{e}|\cdot\Delta t
\end{eqnarray}

$\tau_{e}$は肘関節に与えるトルクである。よって、全体の累積消費エネルギーは、

\begin{eqnarray}
  \equlabel{5.12}
  CE = CE_{s} + CE_{e}
\end{eqnarray}

以上より、報酬の設計は、
\begin{eqnarray}
  \equlabel{5.13}
  Reward = D - CE
\end{eqnarray}

\subsection{その他}
本章では、\equref{Q}における学習率$\alpha$を0.1、割引率$\gamma$を0.9に設定した。これは将来の報酬を優先的に考慮した学習を期待するためである。
1タイムステップは0.001 sであり、1エピソード内のステップ数は3000、すなわち、3 sとした。エピソード数に関しては、\figref{4.2.eps}の中で最も報酬が高いエピソードを採用した。

\section{投擲物の重さに応じた最適投擲フォームの比較}
\subsection{シミュレーション設定}
本検証で用いたパラメータを\tabref{5.3}に示す。身体のサイズは、身長1.72 m、体重70 kgの人間の各部位のサイズとした。
投擲物は、0.14 kg（野球の硬式球）と7.24 kg（砲丸）とした。
\begin{table}[tb]
  \tablabel{5.3}
  \begin{center}
    \caption{Parameters which are used for 2link-4DOF simulation}

    \begin{tabular}{c|c|c}
      \hline
      Parameters & Unit & Values \\
      \hline
      $l_{1}$ & m & 0.32 \\
      $l_{2}$ & m & 0.44 \\
      $l_{f}$ & m & 0.25 \\
      $l_{h}$ & m & 0.19 \\
      $m_{f}$ & kg & 1.12 \\
      $m_{h}$ & kg & 0.42 \\
      $m_{o}$ & kg & 0.14 or 7.24 \\
      $m_{1}$ & kg & 1.96 \\
      $m_{2}$ & kg & 1.68 or 8.78 \\
      \hline
    \end{tabular}
  \end{center}
\end{table}
重力加速度gを9.8 $m/s^{2}$とする。また、前章と同様に、前腕と手と投擲物の要素を合わせて前腕リンクとしてみなすため、3つの要素を考慮して設定を行った。
前腕の要素として、$l_{f}$を前腕長さ、$m_{f}$を前腕重さ、$l_{h}$を手長さ、$m_{h}$を手重さとした。\\

次に、野球の硬式球の重さの投擲物と砲丸重さの投擲物のときのそれぞれの上腕・前腕リンクの重心までの長さ、上腕・前腕リンクの慣性モーメント、肩関節の3軸まわり・肘関節に与えるトルク、肩関節の3軸まわり・肘関節の粘性について、表\tabref{5.4}に示す。各リンクの重心までの長さと慣性モーメントについての計算は、\equref{2.26}から\equref{2.31}を基に行った。各関節に与えるトルクについて、肩関節ピッチ軸とロール軸、肘関節はそれぞれ5種類のトルクから選択される。一方、肩関節ヨー軸周りのトルクについては、スプライン補間によって設定した可動範囲に基づき、可動範囲内にトルクが収まるように与えるトルクも補完する設定とした。

\begin{table}[tb]
  \tablabel{5.4}
  \begin{center}
    \caption{Calculation Results of $l_{g}$、$I$、$\tau$、$b$}

    \begin{tabular}{c|c|c|c}
      \hline
      Parameters & unit & Values of baseball & Values of cannonball \\
      \hline
      $l_{g1}$ & m & 0.16 & 0.16 \\
      $l_{g2}$ & m & 0.21 & 0.40 \\
      $I_{1}$ & kg $\cdot$ ${m}^2$ & 0.017 & 0.017 \\
      $I_{2}$ & kg $\cdot$ ${m}^2$ & 0.15 & 1.59 \\
      $\tau_{p}$ & Nm & -40, -20, 0, 20, 40 & -40, -20, 0, 20, 40 \\
      $\tau_{r}$ & Nm & -40, -20, 0, 20, 40 & -40, -20, 0, 20, 40 \\
      $\tau_{y}$ & Nm & -40, -20, 0, 20, 40 & -40, -20, 0, 20, 40 \\
      $\tau_{e}$ & Nm & -30, -15, 0, 15, 30 & -30, -15, 0, 15, 30 \\
      $b_{p}$ &  & 1.0 & 1.0\\
      $b_{r}$ &  & 0.8 & 0.8\\
      $b_{y}$ &  & 0.5 & 0.5\\
      $b_{e}$ &  & 0.2 & 0.2\\
      \hline
    \end{tabular}
  \end{center}
\end{table}

以上の設定をふまえ、投擲物に応じた投擲フォームの強化学習を行った際の報酬の遷移を\figref{4.2.eps}に示す。0.14 kg の投擲物を遠投するための投擲フォームは
% 本章では、まず0.14 kg の投擲物を投げる際の投擲フォームを導出するために学習を行った。その後、投擲物の重さを0.14 kg から7.24 kgに変更して同様の学習を行ったが、慣性モーメントの大きさやトルク不足の影響で肩のピッチ軸が可動範囲を超えて高速回転をするという人間では不可能な挙動となった。以上の設定をふまえ、投擲物に応じた投擲フォームの強化学習を行った際の報酬の遷移を\figref{4.2.eps}に示す。0.14 kg の投擲物を遠投するための投擲フォームは
\fig{4.2.eps}{width=1.0\hsize}{報酬の遷移}

\subsection{結果・考察}
初期状態について、$\theta_{p}$、$\theta_{r}$、$\theta_{y}$、$\theta_{e}$、$\dot{\theta}_{p}$はランダム値、$\dot{\theta}_{r}$、$\dot{\theta}_{y}$、$\dot{\theta}_{e}$は0とした。これにより、最も報酬が高くなる時の初期姿勢を導出することができる。投擲物に応じた遠投をするための投擲フォーム戦略の結果・考察を以下に示す。
\figref{4.3.eps}は強化学習により最適化した、重さ0.14 kg の投擲物を遠投するための投擲フォーム、\figref{4.4.eps}は強化学習により最適化した、重さ7.24 kg の投擲物を遠投するための投擲フォームである。投擲フォームは投擲開始からリリースまでとし、リリース瞬間の肩関節3軸周りと肘関節の角度、手先の高さ、手先速度、投射角、投擲物の飛距離を\tabref{5.5}に示す。リリース瞬間は、重さ0.14 kg の投擲物の投擲フォームのリリース瞬間は0.489 s、

\begin{table}[tb]
  \tablabel{5.5}
  \begin{center}
    \caption{Data at the moment of release}

    \begin{tabular}{c c c c}
      \hline
      Parameters & unit & Values of 0.14 kg & Values of 7.24 kg \\
      \hline
      $\theta_{p}$ & deg & -125.11 &  \\
      $\theta_{r}$ & deg & -136.91 &  \\
      $\theta_{y}$ & deg  & 36.30 &  \\
      $\theta_{e}$ & deg & -23.52 &  \\
      $h$ & m & 1.96 &  \\
      $v_{syn}$ & m/s & 26.00 &  \\
      $\theta_{v}$ & deg & 48.27 &  \\
      $D$ & m & 70.17 &  \\
      \hline
    \end{tabular}
  \end{center}
\end{table}

\figref{4.5.eps}は投擲開始からリリースまでの肩関節3軸周り、肘関節周りのトルクの推移、\figref{4.6.eps}は投擲開始からリリースまでの上腕リンク、前腕リンク、手先の運動エネルギーの推移である。\figref{4.5.eps}、\figref{4.6.eps}の左図が重さ0.14 kg の投擲物を遠投するための投擲フォームの各時系列、右図がの重さ7.24 kg の投擲物を遠投するための投擲フォームの各時系列である。\\
トルクの時系列より、野球の硬式球の重さの投擲物を遠投するための投擲フォームは、肩関節と肘関節の運動連鎖を活かした投擲フォーム戦略の傾向が見られた。投擲開始からまず肩関節のトルクによって腕を回転させる。その後、約0.13 s で肩トルクが腕の回転とは逆方向にトルクが生じ、肘のトルクが腕の回転と同方向にトルクが生じリリースを迎える。これは肩関節のエネルギーを肘関節に伝達することでより手先方向のエネルギーを大きくしていると考えられる。また、肩関節と肘関節の角速度の推移より、トルクの入力に運動連鎖の傾向が見られる約0.13 s から肩関節の角速度が減少し肘関節の角速度が増加する。リリース時には肩関節と肘関節の角速度が逆転していることから最後は前腕の振りを如何に大きくするのかが重要であると考えられる。一方、砲丸の重さの投擲物を遠投するための投擲フォームは、肩関節による影響が大きい投擲フォームの傾向が見られた。投擲開始から肩関節のトルクによって腕を回転させる傾向は野球の硬式球の重さの投擲物の際と同様であるが、肩関節のトルクが0となる瞬間が数回生じ、また肘関節のトルクは肘を屈曲させる方向に生じ続けている。これは、肩関節のトルクによる腕の回転はペナルティである累積消費エネルギーへの影響が大きく、抑制するためであると考えられる。また、肘関節のトルクによって肘を屈曲させ続ける傾向にある理由として、モーメントアームを小さくすることで肩の回転に消費するエネルギーを抑制するためであると考えられる。加えて肩関節と肘関節の角速度の推移より、肘関節の角速度が正となるのが遅く、リリースの瞬間も肩関節の角速度が肘関節の角速度より大きい。すなわち、肩関節の影響が野球の硬式球の重さの投擲物を遠投する際よりも大きいと考えられる。\\
